# Web的工作方式

## 一、上网过程

1. 输入URL后浏览器请求DNS服务器
2. DNS服务器解析URL获取IP
3. DNS服务器与IP对应的IP服务器建立TCP连接
4. 浏览器发送HTTP Request（请求）包
5. 服务器接收请求包
6. 请求包接收完成后，处理请求包，并调用自身服务进行处理数据
7. 数据处理完成后，返回HTTP Response(响应)包给客户端
8. 浏览器接收到响应包后，渲染Response中的数据
9. 浏览器接收全部响应内容后断开与服务器之间的TCP连接



## 二、Web服务器的工作原理

- 客户机通过 TCP/IP 协议建立到服务器的 TCP 连接
- 客户端向服务器发送 HTTP 协议请求包，请求服务器里的资源文档
- 服务器向客户机发送 HTTP 协议应答包，如果请求的资源包含有动态语言的内容，那么服务器会调用动态语言的解释引擎负责处理 “动态内容”，并将处理得到的数据返回给客户端
- 客户机与服务器断开。由客户端解释 HTML 文档，在客户端屏幕上渲染图形结果



## 三、URL和DNS解析

### 3.1. URL(Uniform Resource Locator)

URL是“统一资源定位符”的英文缩写，用于描述一个网络上的资源，基本格式如下：

>scheme://host[:port#]/path/.../?[?query-string][#anchor]
>scheme         指定底层使用的协议(例如：http,https,ftp)
>host           HTTP服务器的IP地址或域名
>port#          HTTP服务器的默认端口是80，这种情况下端口可以省略。如果使用了别的端口，必须指明，例如http://localhost:8080/
>path           访问资源的路径
>query-string    发送为http服务器的数据
>anchor         锚



### 3.2. DNS(Domain Name System)

DNS是“域名系统”的英文缩写，是一种组织成域层次结构的计算机和网路服务命名系统，它用于TCP/IP网络，它从事将主机名或域名转换为实际的IP地址工作

DNS的解析过程

- 浏览器中输入(www.qq.com)域名后，操作系统检查本地的`hosts`文件是否映射关系，如果有就调用这个IP地址映射，完成域名解析
- `hosts`文件中不存在域名映射，则查找`本地DNS解析器`缓存，是否有这个网址映射关系，存在在直接返回，完成域名解析
- `hosts`与本地DNS解析器缓存都没有响应的网址映射关系，首先会找`TCP/IP`参数中设置的首选`DNS服务器`,即本地DNS服务器，如果要查询的域名，包含在本地配置区域资源中，则返回解析结果给客户机，完成域名解析，此解析具有权威性
- 如果要查询的域名，不由本地DNS服务器区域解析，但该服务器已缓存了此网址映射关系，则调用这个IP地址映射，完成域名解析，此解析不具有权威性
- 如果本地DNS服务器本地区域文件与缓存解析都失效，则根据本地DNS服务器的设置（是否设置转发器）进行查询，如果未用转发模式，本地DNS就把请求发至“根DNS服务器”，“根DNS服务器”收到请求后会判断这个域名(.com)是由谁来授权管理，并返回一个负责该顶级域名服务器的一个IP。本地DNS服务器收到IP信息后，将会联系负责.com域的这台服务器。这台负责.com域的服务器收到请求后，如果自己无法解析，他就会找一个管理.com域的下一级DNS服务器地址(qq.coom)给本地DNS服务器。当本地DNS服务器收到这个地址后，就会找qq.com域服务器，重复上述过程，进行查询，直至找到www.qq.com主机
- 如果用的是转发模式，此DNS服务器就会把请求转发至上一级DNS服务器，由上一级服务器进行解析，上一级服务器如果不能解析，或找根DNS或把请求转至上级，以此循环。不管是本地DNS服务器是转发还是根提示，最后都是把结果返回给本地DNS服务器，由此DNS服务器再返回给客户机



## 四、HTTP协议

### 4.1. 什么是HTTP协议

HTTP是一种让Web服务器与浏览器（客户端）通过internet发送与接收数据的协议，它建立在TCP协议之上，一般采用TCP的80端口。它是一个请求、响应协议--客户端发出一个请求，服务器响应这个请求。在HTTP中，客户端总是通过建立一个连接与发送一个HTTP请求来发起一个事物。服务器不能主动去与客户端联系，也不能给客户端发出一个回调连接。客户端与服务端都可以提前中断一个连接



HTTP协议是无状态的，同一个客户端的这次请求和上一次请求是没有对应关系的，对HTTP服务器来说，它并不知道这两个请求是否来自同一个客户端。为了解决这一问题，Web程序引入了Cookie机制来维护连接的可持续状态

### 4.2. HTTP请求包(浏览器信息)



Request包的结构：

1. 请求行(request line)
2. 请求头(request header)
3. 主体(body),也叫做消息体

主体和请求头之间有个空行用于分割请求头和消息体



请求包示例：

```html
GET /domains/example/ HTTP/1.1    //请求行： 请求方法 请求 URI HTTP 协议/协议版本

Host: www.qq.com                 //服务端的主机名

User-Agent: Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.4 (KHTML, like Gecko)

Chrome/22.0.1229.94 Safari/537.4  //浏览器信息

Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8  //客户端能接收的mine

Accept-Encoding:gzip,defalte,sdch  //是否支持流压缩

Accept-Charset:UTF-8,*;q=0.5      //客户端字符编码集

//空行，用于区分请求头和消息体

//消息体，请求资源参数，例如POST传递的参数
```





### 4.3 HTTP响应包(服务器信息)

Response包的结构：



```html
HTTP/1.1 200 OK                     // 状态行
Server: nginx/1.0.8                 // 服务器使用的 WEB 软件名及版本
Date: Tue, 30 Oct 2012 04:14:25 GMT     // 发送时间
Content-Type: text/html             // 服务器发送信息的类型
Transfer-Encoding: chunked          // 表示发送 HTTP 包是分段发的
Connection: keep-alive              // 保持连接状态
Content-Length: 90                  // 主体内容长度
// 空行 用来分割消息头和主体
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"... // 消息
```

响应包的第一行叫做状态行，由HTTP协议的版本号，状态码，状态消息三部分组成。



HTTP/1.1 协议中定义了 5 类状态码， 状态码由三位数字组成，第一个数字定义了响应的类别

- 1XX 提示信息 - 表示请求已被成功接收，继续处理
- 2XX 成功 - 表示请求已被成功接收，理解，接受
- 3XX 重定向 - 要完成请求必须进行更进一步的处理
- 4XX 客户端错误 - 请求有语法错误或请求无法实现
- 5XX 服务器端错误 - 服务器未能实现合法的请求



HTTP 协议是无状态的和 Connection: keep-alive 的区别

无状态是指协议对于事务处理没有记忆能力，服务器不知道客户端是什么状态。从另一方面讲，打开一个服务器上的网页和你之前打开这个服务器上的网页之间没有任何联系。

HTTP 是一个无状态的面向连接的协议，无状态不代表 HTTP 不能保持 TCP 连接，更不能代表 HTTP 使用的是 UDP 协议（面对无连接）。

从 HTTP/1.1 起，默认都开启了 Keep-Alive 保持连接特性，简单地说，当一个网页打开完成后，客户端和服务器之间用于传输 HTTP 数据的 TCP 连接不会关闭，如果客户端再次访问这个服务器上的网页，会继续使用这一条已经建立的 TCP 连接。

Keep-Alive 不会永久保持连接，它有一个保持时间，可以在不同服务器软件（如 Apache）中设置这个时间。



第一次请求 url，服务器端返回的是 html 页面，然后浏览器开始渲染 HTML：当解析到 HTML DOM 里面的图片连接，css 脚本和 js 脚本的链接，浏览器就会自动发起一个请求静态资源的 HTTP 请求，获取相对应的静态资源，然后浏览器就会渲染出来，最终将所有资源整合、渲染，完整展现在我们面前的屏幕上。

> 网页优化方面有一项措施是减少 HTTP 请求次数，就是把尽量多的 css 和 js 资源合并在一起，目的是尽量减少网页请求静态资源的次数，提高网页加载速度，同时减缓服务器的压力。



————————————————
原文作者：Go &#25216;&#26415;&#35770;&#22363;&#25991;&#26723;&#65306;&#12298;Go Web &#32534;&#31243;&#65288;&#65289;&#12299;
转自链接：https://learnku.com/docs/build-web-application-with-golang/031-web-working-mode/3168

