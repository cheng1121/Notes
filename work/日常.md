# 日常

## 问题

1. ~~跨年请假（加班、出差）时，下一考勤期间数据没有生成，导致数据丢失-------(跨年情况)~~  

   申请需要校验下一年度的考勤期间是否存在，不存在则提示联系管理员（2021-10-14 10:27） 

2. 我的假勤交互，浮层展示旷工内容：

   - 全天旷工 仅展示------旷工
   - 迟到早退导致的旷工 ---------- 旷工 + 打卡时间
   - 漏打卡导致的旷工 ---------  当天展示为缺卡，计算完日明细后展示为旷工，补卡后消掉旷工数据
   
3. 公式编辑器

   - 函数区域（数值、字符、日期、逻辑、转换、特殊薪酬、二开、分支）
   - 信息体系项目
   - 薪酬体系项目
   - 考勤体系项目
   - 临时项目（类似临时变量【考勤目前应该没有】）
   - 需要手动输入公式（需要校验手动输入的公式的合法性，校验是个难点）
   - 说明内容需要自适应
   - 内容输入区域需要放大
   - 关键字左右需要添加#作为标识并增加高亮
   - 输入的中文左右需要使用单引号
   - 键盘去掉阿拉伯数字，增加单引号
   - 根据左侧选择的函数，右侧信息项会有相应改变；函数有多个参数时参数位置需要空出来

## 2021年11月19日

- 加班时长计算补充逻辑
- 调休和调休销假数据处理bug



## 2021年11月18日

- 加班时长计算逻辑验证和bug修复
- 调休假期余额发放bug修复；
- 定时任务配置

## 2021年11月17日

同16日

## 2021年11月16日

- 加班申请时长计算修改(70%)
  - 有班次的时长计算（100%）
  - 没有班次的时长计算
    - 有打卡数据的计算(10%)
    - 没有打卡数据的计算

## 2021年11月15日

- 加班申请时长计算修改
- 调休申请审批通过后，加班转调休表中冻结额度、增减余额、剩余额度等数据处理有问题





## 2021年11月12日

- 假期申请时长计算bug修复

- 销假数据到日明细数据bug修复

- 假期申请单列表数据重复问题

  

## 2021年11月11日

### 加班时长计算bug修复

- 所有表的 

  - name: 50中文 200字符
  - 说明、备注、事由：中文1000   字符2000

- ~~出差申请 （kq_apply_businesstrip）~~

  - 事由( REASON)：前端 -> 1000    后端 -> 2000

- ~~调休申请（kq_apply_exchangerest）~~

  - 事由( REASON)：前端 -> 1000    后端 -> 2000
  - 销假事由（REVISE_REASON）：前端 -> 1000    后端 -> 2000

- ~~加班申请（kq_apply_extrawork）~~

  - 事由（REASON）：前端 -> 1000    后端 -> 2000

- ~~假期申请（kq_apply_leave）~~

  - 事由（REASON）：前端 -> 1000    后端 -> 2000
  - 销假事由（REVISE_REASON）：前端 -> 1000    后端 -> 2000

- ~~补卡申请（kq_apply_mendtimeclock）~~

  - 事由（REASON）：前端 -> 1000    后端 -> 2000

- ~~销假申请（kq_apply_reviseleave）~~

  - 事由（REASON）：前端 -> 1000    后端 -> 2000

- ~~出差规则表 （kq_businesstrip_rule）~~

  - 说明（comment）：前端 -> 1000    后端 -> 2000
  - 名称（name）：前端 -> 50    后端 -> 200

- ~~考勤日明细表 （kq_daily_data）~~

  - comment：  后端  -> 2000

- ~~加班规则表  （kq_extra_work_rule）~~

  - 说明（comment）：前端 -> 1000    后端 -> 2000
  - 名称（name）：前端 -> 50    后端 -> 200

- ~~节假日设置表 (kq_holiday)~~

  - 说明（comment）：前端 -> 1000    后端 -> 2000
  - 名称（name）：前端 -> 50    后端 -> 200

- ~~考勤项目表（kq_item）~~

  - 备注（ REMARK）：前端 -> 1000   后端 -> 2000
  - 项目名称（ITEM_NAME）： 前端 -> 50 后端 -> 200
  - 项目别名（ITEM_ALIAS）： 前端 -> 50 后端 -> 200

- ~~假期规则（kq_leave_rule）~~

  - 说明（comment）：前端 -> 1000    后端 -> 2000
  - 名称（name）：前端 -> 50    后端 -> 200

- ~~补卡规则（kq_mendtimeclock_rule）~~

  - 说明（comment）：前端 -> 1000    后端 -> 2000
  - 名称（name）：前端 -> 50    后端 -> 200

- ~~考勤方案（kq_scheme）~~

  - 说明（comment）：前端 -> 1000    后端 -> 2000
  - 名称（name）：前端 -> 50    后端 -> 200

- ~~班次规则（kq_shifts）~~

  - 说明（comment）：前端 -> 1000    后端 -> 2000
  - 名称（name）：前端 -> 50    后端 -> 200

- ~~班次时段基础数据表（kq_sign_base_data）~~

  - 说明（comment）: 后端 -> 2000

- ~~打卡方式（kq_signaddress）：~~

  - 名称(NAME)（地点名称、wifi名称、考勤机名称）: 前端 -> 50  后端 -> 200
  - 地址(ADDRESS)（签到地址、考勤机安装地址）：前端 -> 200 后端 -> 500

- ~~月汇总（kq_summary）~~

  - 备注（remark）: 前端 -> 1000    后端 -> 2000

  -  需要添加到月汇总封存表中的字段

      `SCHEMEID` varchar(36) DEFAULT NULL COMMENT '方案id',
      `SUMMARYTIME` datetime DEFAULT NULL COMMENT '汇总时间',
      `REPORTTIME` datetime DEFAULT NULL COMMENT '上报时间',
      `CONFIRMTIME` datetime DEFAULT NULL COMMENT '归档时间',
      `KQUSER` varchar(36) DEFAULT NULL COMMENT '考勤员',
      `GDUSER` varchar(36) DEFAULT NULL COMMENT '归档员',
      `REMARK` varchar(1000) DEFAULT NULL COMMENT '备注',

- ~~考勤期间（kq_term）~~

  - 说明（comment）：前端 -> 1000    后端 -> 2000
  - 名称（name）：前端 -> 50    后端 -> 200



## 2021年11月10日

- 个人申请中不展示给他人申请的申请单



## 2021年11月09日

- 流程bug修复
- 个人自助申请列表bug
- 申请单新增根据流程id获取详情接口



## 2021年11月08日

- 假期规则：删除添加是否已使用校验，未使用过的才能删除
- 假期余额：新增假期类型列表接口



## 2021年11月05日

- 假期申请，假期类型列表展示不全（人员关系所在单位为其上级单位，所以获取到的假期类型就是其上级单位或者上级单位的父级单位开启了适用下级）
- 假期、加班、出差、补卡规则列表展示上级单位已启用的规则，相关bug修复
- 假期余额发假bug修复

## 2021年11月04日

- 补卡规则新增时添加是否有已启用的校验

## 2021年11月03日

- 调休假规则新增时添加重复启用校验()
- 



## 2021年11月02日

### Bug修复

- 加班规则设置最小加班时长等字段长度越界
- 基础设置无法修改启用状态
- 调休假规则一直显示存在重复的调休假规则（需要前端在列表中点击启用时 校验是否启用成功）
- 



## 2021年10月29日

- 假期规则：校验已用的规则无法删除 （100%）
- 出差申请：时长计算错误  （100%）
- 出勤项目统计（完成）
  1. 实出勤小时：ITEM003 =   ？  日明细中应该有当天的出勤时长字段
  2. 实出勤天数：ITEM004 = 是否出勤 IS_ATTENDANCE = 1
  3. 缺勤小时数：ITEM005 =  (计算方式？)
  4. 迟到分钟数：ITEM006 = 迟到累计分钟 LATE_IN_MIN
  5. 迟到次数：ITEM007 = LATE_COUNT
  6. 早退分钟数：ITEM008 = EARLY_OUT_MIN
  7. 早退次数：ITEM009 = EARLY_COUNT
  8. 旷工小时数：ITEM010 = ABSENT_DAY * 班次时长 SHIFT_WORK_HOURS
  9. 旷工天数：ITEM011 = ABSENT_DAY
  10. 旷工次数：ITEM012 = 计算方式？（一天一次旷工，旷工天数 > 0 ?）
  11. 补卡次数：ITEM013 = MEND_CLOCK_COUNT

## 2021年10月28日

- 出差申请：拆分出差申请数据到出差日明细表
- 出差申请：计算出差日明细数据（是否出勤、是否出差、出差时长以及出差相关的考勤项目）

## 2021年10月27日

- 出差申请：申请时长计算根据班次以及规则重写（100%）

## 2021年10月26日

- 考勤日明细统计存储过程开发和调试（添加考勤项目相关计算）（100%）

## 2021年10月23日

### 一、加班数据转为日明细数据

1. 数据库设计(100%)

2. 实体类、service、mapper等基础文件(完成)




## 2021年10月22日

1. 审批通过后销假日期拆分为每天数据，存储到假期日明细表（100%）
2. 处理每日的销假时长，调整请假状态、出勤状态、请假时长以及请假对应的考勤项目(100%)
3. 调休销假处理同上（100%）
4. 调休数据处理后存入日明细（100%）

## 2021年10月19日

### 1. 销假申请数据 抵消 请假数据

- 审批通过后销假日期拆分为每天数据，存储到假期日明细表（50%）
- 处理每日的销假时长，调整请假状态、出勤状态、请假时长以及请假对应的考勤项目



### 2. 加班申请 -> 日明细





## 2021年10月18日

### 1. 请假日明细到考勤项目的计算逻辑和bug修复（完成）



## 2021年10月15日

### 一、补充请假日明细数据（请假日明细表和考勤日明细表）（80%）

- 请假标识
- 假期考勤项目计算每日的结果
- 请假日明细表需要存储考勤项目编码



## 2021年10月14日

### 一、申请管理完善

1. 请假申请
   - 跨年申请：下一年度考勤期间校验 (完成）
   - 部门全路径 (完成）
2. 销假申请
   - 跨年申请：下一年度考勤期间校验  (完成）
   - 部门全路径 (完成）
3. 调休申请
   - 跨年申请：下一年度考勤期间校验 (完成）
   - 部门全路径 (完成）
4. 出差申请
   - 跨年申请：下一年度考勤期间校验 (完成）
   - 部门全路径  (完成）
5. 加班申请
   - 跨年申请：下一年度考勤期间校验 (完成）
   - 部门全路径  (完成）
6. 补卡申请
   - 部门全路径 (完成）

### 二、组织机构选人(完成)

- 补充逻辑---- 部门存在人员即可展开(目前是只有组织机构的逻辑，没有人员相关逻辑)（完成）

## 2021年10月13日

### 一、通用规则设置详情和列表

1. 班次规则列表和详情(完成)
   - 列表：新增b0101
   - 详情：新增b0101

### 二、补充考勤日明细中的系统项字段（已完成）

### 三、补充日常管理和申请管理中部门全路径

1. 假期余额

   代码编写完成

2. 考勤明细

   （完成）


## 2021年10月12日



### 一、bug修复

1. 上下班时间返回格式化（完成）
2. 假期申请单查重bug，申请单id参数名称和后端命名不匹配



### 二、通用规则设置详情和列表

1. 假期规则:新增返回字段b0101(完成)
2. 加班规则：新增返回字段b0101,加班类型名称，最小加班时长名称，递增加班时长名称，加班时长单位名称(完成)
3. 出差规则：新增返回字段b0101 (完成)
4. 补卡规则：新增返回字段b0101(完成)

## 2021年10月11日

### 一、完善假期申请时长计算

1. 没有额度限制的假期添加单位换算逻辑(完成90%)

### 二、组织机构树bug修复(完成)

## 2021年10月08日

### 一、假期申请时长计算功能调试

1. bug修复
2. 新增假期余额校验（100%）
3. 新增假期申请规则校验（100%）



## 2021年09月30日

1. 申请时长重新计算，要结合相应的班次（100%）（没有额度限制的假期规则，按照申请时长或者相应的假期规则规定的时长计算）
2. 时长计算，获取开始结束时间添加哺乳假相关规则（申请哺乳假时，没有选择时间）

#### 问题

1. 时长计算：节假日和休息日没有班次，也就没有一天的时长；此时计算申请时长一天应该设置多少时长？（没有班次的时长先按照0计算）
2. 其他假期中是否有特殊假期？如不能销假的？（都可以销假）
3. 哺乳假的午休开始前，午休结束后在多个班次中如何界定（午休去掉了）



## 2021年09月29日

### 一、 请假申请单完善

1. 假期类型要排除调休假规则（完成）

## 2021年09月28日

- 调休获取加班信息列表，数据回显可能有问题需要测试(完成)

- 出差申请，类型筛选bug修复（完成）

  

## 2021年09月27日

### 0.bug修复

- 假期余额发假功能获取不到人员（需要检查代码）(完成)
- 假期申请，提交后审批状态错误（完成）

## 2021年09月26日

### 0. bug修复

- 调休审批是加班信息冻结时长、已用时长、剩余时长未改变（完成）

### 1. 假期余额

- 列表筛选功能机构、年份、假期类型、姓名/工号、部门、人员id(完成)

### 2. 销假申请支持调休销假（完成）

- 获取销假申请时长
- 获取人员基本信息

## 2021年09月24日

### 0. bug修复

- 获取调休假余额sql报错（完成）
- 调休申请审批时sql报错（完成）
- 调休查看是获取加班信息sql报错（完成）

### 1. 假期余额功能优化

- 假期余额列表增加筛选指定人员的数据（完成）
- 发假功能修改：（完成）
  - 按照考勤期间发假
  - 需要选择单位节点

### 3. 获取补卡时间（逻辑梳理）

1. 根据人员id和补卡日期(yyyy-MM-dd)获取当天打卡记录
   - 数据在`kq_sign_data`表中，根据`a00`和`KQWC2301`(考勤日期)获取
   - 获取到的集合中的每条记录是对应着当天的班次时段
2. 判断实际打卡时间
   - 根据`KQWC2303`(签到[上班]时间)和`KQWC2304`(签退[下班]时间)来判断
   - `KQWC2303`为空，则表示该班次时段未打上班卡（多个时段选最早的时段）
   - `KQWC2304`为空，则表示该班次时段未打下班卡（多个时段选最晚的时段）
   - 两个都为空则这个班次时段为旷工、请假、出差(旷工不知道能不能补卡？)
3. 根据班次id`KQWC2302`获取是否有弹性规则(`kq_shifts`表)
   - `IF_FLEXIBLE`：是否可早到早走
   - `IF_FLEX_LATEO`：是否可晚到晚走
4. 补卡时间判断
   1. 班次时段为1个
      - 可以晚到晚走和可早到早走:
        - 上班补卡时间为：此班次时段个人规则最晚签到时间
        - 下班补卡时间为：此班次时段个人规则最早签退时间
      - 没有弹性规则：
        - 上班补卡时间：此班次时段上班打卡时间(`kq_shifts_time`表中的`workin_time`)
        - 下班补卡时间：此班次时段下班打卡时间(`kq_shifts_time`表中的`workout_time`)
   2. 班次时段为多个
      - 有弹性规则：
        - 上班补卡时间为：时间范围最早的班次时段，个人规则最晚签到时间
        - 下班补卡时间为：时间范围最晚的班次时段，个人规则最早签退时间
      - 没有弹性规则
        - 上班补卡时间：时间范围最早的班次时段上班打卡时间(`kq_shifts_time`表中的`workin_time`)
        - 下班补卡时间：时间范围最晚的班次时段下班打卡时间(`kq_shifts_time`表中的`workout_time`)





## 2021年09月23日

### 1. 加班转调休相关

- 审批通过：(完成)

  1. 冻结额度清零，
  2. 使用额度需要加上冻结额度，剩余额度不变
  3. 加班申请单需要有相应的操作

- 审批驳回和撤回：（完成）

  1. 被驳回的调休申请中用到的已到期的加申请单需要自动续期？（需要延期(调休假规则中增加驳回延期字段)，最多自动延期30天）
  2. 恢复冻结的时长，剩余时长等数据
  3. 加班信息使用记录表中的增加使用记录

- 调休销假：(完成)

  审批通过后额度表中已用额度需要减去销假时长；加班申请单需要中的使用时长也需要减去销假时长（~~此处有个问题，销假时长对应的申请单已过期需要自动续期么？~~）（销假时已过期的加班信息不可再用）

## 2021年09月22日

### 0. 功能优化，bug修复

- 调休假规则新增字段，审批驳回后延期天数（完成）
- 加班审批后保存信息到加班转调休记录表(日期格式化对比错误、调休假规则获取bug)（完成）

### 1. 加班转调休相关

1. 调休申请时需要的操作

   - 审批中和待审批：(完成)

     - 额度表冻结申请的额度；
     - 加班申请单冻结相同的额度（单个加班申请单可冻结部分额度；也可多个加班申请单组成一个使用额度）；
     - 剩余额度需要减去冻结额度；
     - 加班信息记录表需要记录使用情况


## 2021年09月18日

### 1. 加班转调休相关

1. 获取加班信息列表筛选包括历史加班记录回显（完成）

   1. 筛选条件：查看或者新增调休申请

   2. 筛选逻辑：

      - 调休申请查看（审批、编辑）：根据调休申请单中的字段进行筛选

        需要用到的字段：调休申请单申请时间；申请时长字段；加班信息的剩余时长或者是否已用完字段；

        1. 加班信息结束时间大于调休申请时间的申请单不考虑
        2. 调休申请时间 + 调休假规则额度 筛选出 此时间范围内的加班信息为`未过期`加班信息
        3. 调休申请时长的组成：步骤2筛选出来的加班信息按照有效期结束时间倒序排序，靠近年初的一个加班信息的部分调休时长或者几个加班信息的调休时长累加；这几个加班信息的状态为`冻结`状态
        4. 如果步骤2筛选出来的加班信息的剩余时长为0或者已用完字段为1则表示改加班信息为`已用`状态
        5. 步骤2筛选出来的数据之前的数据为`已过期`状态
        6. 为了还原当时的状态需要一个流水表用来记录加班信息的使用情况




## 2021年09月17日

### 0. Bug修复

1. 调休假个人自助列表不显示（完成）
2. 加班申请修改id返回位置错误（完成）
3. 获取调休假余额sql错误（完成）
4. 加班申请提交后,列表未返回flowId(完成)

### 1. xxl-job 定时任务使用方法梳理

 详情见 [xxl-job的使用.md](xxl-job的使用.md) 

### 2. 加班转调休相关

1. 调休申请新增：直接查询kq_overtime_to_rest表，分页查询(完成)

## 2021年09月16日

### 0. bug修复

- 月汇总自定义显示字段参数错误(完成)
- 加班申请获取详情，sql错误(完成)
- 调休规则设置增加折算时长字段和结转延期字段（完成）
- 加班申请表新增补贴类型名称字段（完成）
- 加班申请列表类型筛选报错（完成）

### 1. 申请单查重需要增加申请单id参数（完成）

- 编辑时查重需要把当前编辑的申请单去掉，也就是正在编辑的申请单不参与查重

### 2. 加班转调休相关

- 定时任务计算调休有效期内的剩余额度等数据  (完成)

  - 按照日期获取加班转调休记录表中的数据
  - 对数据按照人员进行分组，并根据规则计算余额

  - 额度计算时，需要需要处理跨年结转问题；（有效期跨年也就是结束日期在当年12月31日以后，需要根据规则自动延期指定月份）

## 2021年09月15日

### 1. 加班转调休相关

- 设计并创建加班调休记录表（完成）

- 加班审批通过后，生成转调休的加班申请单记录（加班申请单及加班规则信息）（完成）

  - 上下班时间

  - 计算出实际加班时长，转调休时长，有效期起止日期等

- 分页列表功能（完成）

### 2. 加班规则新增不分页列表（完成）



## 2021年09月14日

### 1. 调休申请单获取详情报错（已完成，sql少个逗号）

### 2. 假期规则适用日期修改为多项(完成)

### 3.  申请单新增时获取班次开始结束时间  (完成)

- 通过班次获取上下班时间

### 4. 加班申请单功能优化

- 计算加班申请时长（完成）
- 检查是否有重复的申请单（完成）
- 获取人员范围内的加班类型(即：加班规则)列表（完成）
- 获取加班开始时间(完成)

##  2021年09月13日

### 1. 申请单

- 列表查询权限问题（已完成）

- 按照类型筛选；姓名/工号/流水号筛选
  1. 请假申请(已完成)
  2. 销假申请（已完成）
  3. 出差申请（已完成）
  4. 加班申请（已完成）
  5. 调休申请（完成<赵迎召>）
  6. 补卡申请（完成<赵迎召>）
-  申请单新增时获取班次开始结束时间  (代码编写完成)
  - 通过班次获取上下班时间

### 2. 机构树人员模糊查询（已完成）

模糊查询需要返回树形结构

~~遇到的问题：~~

- ~~卡在构建返回数据时没想好如何拼装为树形结构~~
- ~~获取某有机构下的人员列表可能也有问题，人员数据的准确度（未验证过）~~

### 3. 加班申请单功能优化

- 计算加班申请时长
- 检查是否有重复的申请单
- 获取人员范围内的加班类型(即：加班规则)列表



## 2021年09月10日

### 1. 加班申请功能优化

- 计算加班申请时长
- 检查是否有重复的申请单
- 获取人员范围内的加班类型(即：加班规则)列表

### 2. 申请单功能优化

- 返回增加创建人和申请日期（完成）
- 列表查询增加权限（完成）(出差申请列表权限导致查询不到列表)
- 出差申请列表分页出差类型查询需要支持多个类型
- bug修复

### 3. 机构树人员模糊查询优化





## 2021年09月09日

### 1. 加班申请功能优化

- 列表查询和详情 （已完成）
- 计算加班申请时长
- 检查是否有重复的申请单
- 获取人员范围内的加班类型(即：加班规则)列表

### 2. 加班规则设置功能优化(已完成)

- 加班申请方式修改为：1有，0无。1时：转调休比例必须传



## 2021年09月08日

### 1. 申请单流水号规则记录表（已完成）

流水号规则：

- 拼音缩写(如请假：QJ)`-` 年月(如：202109)`-` 6位数字(123456)
- 数字长度需要根据个申请单情况定制

### 2. 申请时出差类型,列表优化(已完成)

- 出差/加班规则和类型名称拼接规则：类型名称(规则名称)
- 列表筛选添加根据类型筛选
- 获取人员范围内的出差类型列表

### 3. 加班申请功能优化

- 保存、修改、删除功能（完成）
- 列表查询和详情 
- 计算加班申请时长
- 检查是否有重复的申请单
- 获取人员范围内的加班类型(即：加班规则)列表



## 2021年09月07日

### 1. 调休假查重功能（已完成）

- 新增时，检查调休假是否已存在，存在则不能新增调休假
- 父机构的调休假规则如果设置了适用下级，则视为已存在

### 2. 申请单流水号记录表

流水号规则：

- 拼音缩写(如请假：QJ)`-` 年月(如：202109)`-` 6位数字(123456)
- 数字长度需要根据个申请单情况定制

#### 完成情况：

- pdm中表设计完成

### 3. 修复申请出差时长bug(已完成)

### 4. 出差申请列表bug修复(已完成，理解错误)

- 列表筛选添加出差规则id参数
- 列表返回出差规则名称

### 5. 申请时出差类型、加班类型列表优化

- 列表每项名称拼接规则：类型名称(规则名称)

完成情况：

- 出差类型列表修改完成
- 加班类型列表未开始修改



## 2021年09月06日

1. 考勤项目列表bug修复
2. 考勤组织机构选择功能，懒加载、机构树带人员、人员筛选

